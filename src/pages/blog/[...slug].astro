---
import { getCollection } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import { ArrowLeft, Calendar, User } from 'lucide-react';
import BlogEngagement from '@/components/react/BlogEngagement';
import { Comments } from '@/components/react/Comments';
import { Image } from 'astro:assets';
import { generateArticleSchema, generateBreadcrumbSchema } from '@/lib/schema';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Helper to format date
const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
};

// Generate Article JSON-LD
const siteUrl = Astro.site || 'https://aexaware.com';
const articleSchema = generateArticleSchema({
  headline: post.data.title,
  description: post.data.description,
  image: post.data.image ? new URL(post.data.image.src, siteUrl).href : new URL('/og-image.png', siteUrl).href,
  datePublished: post.data.date.toISOString(),
  dateModified: post.data.date.toISOString(),
  author: {
    name: post.data.author,
  },
  publisher: {
    name: "Aexaware Infotech",
    logo: new URL('/og-image.png', siteUrl).href,
  },
});

// Generate Breadcrumb JSON-LD
const breadcrumbSchema = generateBreadcrumbSchema({
  itemListElement: [
    {
      position: 1,
      name: "Home",
      item: siteUrl.toString(),
    },
    {
      position: 2,
      name: "Blog",
      item: new URL('/blog', siteUrl).href,
    },
    {
      position: 3,
      name: post.data.title,
    },
  ],
});
---

<Layout 
  title={post.data.title} 
  description={post.data.description}
  image={post.data.image?.src}
  type="article"
  publishedTime={post.data.date.toISOString()}
  modifiedTime={post.data.date.toISOString()}
  author={post.data.author}
  tags={post.data.tags}
>
  <!-- Article JSON-LD -->
  <script type="application/ld+json" set:html={articleSchema} slot="head" />
  <script type="application/ld+json" set:html={breadcrumbSchema} slot="head" />
  
  <article class="pt-32 pb-24 lg:pt-48 lg:pb-32">
    <div class="container mx-auto px-6 lg:px-8 max-w-3xl">
      <div class="mb-8">
        <a href="/blog" class="inline-flex items-center -ml-4 text-muted-foreground hover:text-primary transition-colors">
          <ArrowLeft className="mr-2 h-4 w-4" />
          Back to Blog
        </a>
      </div>

      <div class="mb-10">
        <div class="flex flex-wrap gap-2 mb-6">
          {post.data.tags?.map((tag) => (
            <span
              class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80"
            >
              {tag}
            </span>
          ))}
        </div>
        <h1 class="font-serif text-4xl md:text-5xl font-medium leading-tight text-foreground mb-6">
          {post.data.title}
        </h1>
        <div class="flex items-center gap-6 text-muted-foreground text-sm">
          <div class="flex items-center gap-2">
            <User className="size-4" />
            {post.data.author}
          </div>
          <div class="flex items-center gap-2">
            <Calendar className="size-4" />
            {formatDate(post.data.date)}
          </div>
        </div>
        {post.data.image && (
          <div class="mt-8 aspect-video rounded-3xl overflow-hidden bg-muted">
            <Image
              src={post.data.image}
              alt={post.data.title}
              class="w-full h-full object-cover"
              width={1200}
              height={675}
            />
          </div>
        )}
      </div>

      <BlogEngagement 
        client:load 
        url={Astro.url.href} 
        title={post.data.title} 
      />

      <div class="prose prose-lg prose-slate dark:prose-invert max-w-none prose-headings:font-serif prose-headings:font-medium prose-h1:text-4xl prose-h1:leading-tight prose-p:text-muted-foreground prose-p:leading-relaxed prose-a:text-primary prose-a:no-underline hover:prose-a:underline prose-img:rounded-3xl prose-img:shadow-lg">
        <Content />
      </div>
      
      <Comments client:visible />
    </div>
  </article>
</Layout>
