---
import { Button } from "@/components/ui/button";
import { buttonVariants } from "@/components/ui/button-variants";
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Check, ChevronRight, ChevronLeft, Smartphone, Globe, Bot, Code, DollarSign, Calendar, Send, Sparkles } from "lucide-astro";
import { cn } from "@/lib/utils";

const projectTypes = [
    { id: 'mobile', label: 'Mobile App', icon: Smartphone, desc: 'iOS & Android solutions' },
    { id: 'web', label: 'Website / Web App', icon: Globe, desc: 'Responsive & modern web' },
    { id: 'ai', label: 'AI & ML Solution', icon: Bot, desc: 'Intelligent automation' },
    { id: 'custom', label: 'Custom Software', icon: Code, desc: 'Tailored enterprise software' },
];

const budgetRanges = [
    { id: 'lt5k', label: '< $5k', desc: 'MVP or small project' },
    { id: '5k-10k', label: '$5k - $10k', desc: 'Standard business solution' },
    { id: '10k-25k', label: '$10k - $25k', desc: 'Complex application' },
    { id: '25k+', label: '$25k+', desc: 'Enterprise grade platform' },
];

const timelines = [
    { id: 'asap', label: 'ASAP', desc: 'Urgent priority' },
    { id: '1-3m', label: '1 - 3 Months', desc: 'Standard timeline' },
    { id: '3-6m', label: '3 - 6 Months', desc: 'Large scale project' },
    { id: 'flexible', label: 'Flexible', desc: 'Quality first' },
];
---

<div class="w-full max-w-4xl mx-auto p-4" id="project-calculator">
    <div class="mb-8">
        <div class="flex justify-between items-center relative">
            <div class="absolute left-0 top-1/2 -translate-y-1/2 w-full h-1 bg-secondary -z-10 rounded-full"></div>
            <div id="progress-bar" class="absolute left-0 top-1/2 -translate-y-1/2 h-1 bg-primary transition-all duration-500 rounded-full w-[0%]"></div>

            {['type', 'budget', 'timeline', 'details'].map((s, i) => (
                <div class="step-indicator w-10 h-10 rounded-full flex items-center justify-center border-4 transition-colors duration-300 bg-background border-secondary text-muted-foreground" data-step={s} data-index={i}>
                    {i + 1}
                </div>
            ))}
        </div>
        <div class="flex justify-between mt-2 text-xs font-medium text-muted-foreground px-1">
            <span>Type</span>
            <span>Budget</span>
            <span>Timeline</span>
            <span>Details</span>
        </div>
    </div>

    <div class="rounded-xl border border-border/50 shadow-xl backdrop-blur-sm bg-card/95 text-card-foreground">
        <div class="flex flex-col space-y-1.5 p-6 text-center">
            <h3 id="step-title" class="font-serif text-2xl md:text-3xl font-semibold leading-none tracking-tight">What are you building?</h3>
            <p id="step-desc" class="text-lg text-muted-foreground">Select the category that best fits your project.</p>
        </div>

        <div class="p-6 md:p-8 pt-0">
            <!-- Step 1: Type -->
            <div id="step-type" class="step-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {projectTypes.map((item) => (
                        <button
                            class="type-option flex flex-col items-center justify-center p-6 rounded-3xl border-2 transition-all duration-200 hover:border-primary/50 hover:bg-accent/50 text-center gap-4 group border-border"
                            data-value={item.label}
                        >
                            <div class="p-4 rounded-full bg-secondary group-hover:bg-primary/10 transition-colors icon-container">
                                <item.icon class="w-8 h-8 text-muted-foreground group-hover:text-primary transition-colors icon" />
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg">{item.label}</h3>
                                <p class="text-sm text-muted-foreground">{item.desc}</p>
                            </div>
                        </button>
                    ))}
                </div>
            </div>

            <!-- Step 2: Budget -->
            <div id="step-budget" class="step-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {budgetRanges.map((item) => (
                        <button
                            class="budget-option flex flex-col items-center justify-center p-6 rounded-3xl border-2 transition-all duration-200 hover:border-primary/50 hover:bg-accent/50 text-center gap-2 group border-border"
                            data-value={item.label}
                        >
                            <div class="p-3 rounded-full bg-secondary group-hover:bg-primary/10 transition-colors icon-container">
                                <DollarSign class="w-6 h-6 text-muted-foreground group-hover:text-primary transition-colors icon" />
                            </div>
                            <h3 class="font-semibold text-lg">{item.label}</h3>
                            <p class="text-sm text-muted-foreground">{item.desc}</p>
                        </button>
                    ))}
                </div>
            </div>

            <!-- Step 3: Timeline -->
            <div id="step-timeline" class="step-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {timelines.map((item) => (
                        <button
                            class="timeline-option flex flex-col items-center justify-center p-6 rounded-3xl border-2 transition-all duration-200 hover:border-primary/50 hover:bg-accent/50 text-center gap-2 group border-border"
                            data-value={item.label}
                        >
                            <div class="p-3 rounded-full bg-secondary group-hover:bg-primary/10 transition-colors icon-container">
                                <Calendar class="w-6 h-6 text-muted-foreground group-hover:text-primary transition-colors icon" />
                            </div>
                            <h3 class="font-semibold text-lg">{item.label}</h3>
                            <p class="text-sm text-muted-foreground">{item.desc}</p>
                        </button>
                    ))}
                </div>
            </div>

            <!-- Step 4: Details -->
            <div id="step-details" class="step-content hidden">
                <form id="project-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="name" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Full Name</label>
                            <input
                                id="name"
                                name="name"
                                placeholder="John Doe"
                                required
                                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                            />
                        </div>
                        <div class="space-y-2">
                            <label for="email" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Email Address</label>
                            <input
                                id="email"
                                name="email"
                                type="email"
                                placeholder="john@company.com"
                                required
                                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                            />
                        </div>
                        <div class="space-y-2 md:col-span-2">
                            <label for="company" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Company Name (Optional)</label>
                            <input
                                id="company"
                                name="company"
                                placeholder="Your Company Ltd."
                                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                            />
                        </div>
                        <div class="space-y-2 md:col-span-2">
                            <label for="description" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Project Details</label>
                            <textarea
                                id="description"
                                name="description"
                                placeholder="Tell us a bit more about your vision..."
                                class="flex min-h-[100px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                            ></textarea>
                        </div>
                    </div>

                    <div class="rounded-lg bg-secondary/50 p-4 text-sm text-muted-foreground">
                        <p class="font-semibold text-foreground mb-1">Summary:</p>
                        <p>Looking for a <span class="text-primary" id="summary-type">...</span> with a budget of <span class="text-primary" id="summary-budget">...</span>, needed <span class="text-primary" id="summary-timeline">...</span>.</p>
                    </div>

                    <div class="cf-turnstile" data-sitekey="0x4AAAAAACD9PucKWTfuWhPA"></div>

                    <div class="flex justify-end pt-4">
                        <button type="submit" id="submit-btn" class={cn(buttonVariants({ size: "lg" }), "w-full md:w-auto rounded-full")}>
                            Get My Estimate
                            <Send class="ml-2 h-4 w-4" />
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 5: Success -->
            <div id="step-success" class="step-content hidden">
                <div class="flex flex-col items-center justify-center py-12 text-center space-y-6">
                    <div class="w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                        <Sparkles class="w-10 h-10 text-green-600 dark:text-green-400" />
                    </div>
                    <div class="space-y-2">
                        <h3 class="text-2xl font-bold">Thank You!</h3>
                        <p class="text-muted-foreground max-w-md mx-auto">
                            We've received your project details. One of our tech experts will analyze your requirements and send you a preliminary estimate within 24 hours.
                        </p>
                    </div>
                    <a href="/blog" class={cn(buttonVariants({ variant: "outline" }), "rounded-full")}>
                        Read our Blog
                    </a>
                </div>
            </div>
        </div>

        <div id="footer-nav" class="flex justify-between border-t border-border/50 p-6">
            <button id="back-btn" class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 rounded-full hidden">
                <ChevronLeft class="mr-2 h-4 w-4" />
                Back
            </button>
            <div id="step-counter" class="text-sm text-muted-foreground flex items-center">
                Step 1 of 4
            </div>
        </div>
    </div>
</div>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
    // State
    let currentStep = 0;
    const steps = ['type', 'budget', 'timeline', 'details', 'success'];
    const data = {
        type: '',
        budget: '',
        timeline: '',
        name: '',
        email: '',
        company: '',
        description: ''
    };

    // DOM Elements
    const progressBar = document.getElementById('progress-bar');
    const stepIndicators = document.querySelectorAll('.step-indicator');
    const stepContents = document.querySelectorAll('.step-content');
    const stepTitle = document.getElementById('step-title');
    const stepDesc = document.getElementById('step-desc');
    const backBtn = document.getElementById('back-btn');
    const stepCounter = document.getElementById('step-counter');
    const footerNav = document.getElementById('footer-nav');
    const summaryType = document.getElementById('summary-type');
    const summaryBudget = document.getElementById('summary-budget');
    const summaryTimeline = document.getElementById('summary-timeline');
    const form = document.getElementById('project-form');
    const submitBtn = document.getElementById('submit-btn');

    // Content Data
    const stepInfo = {
        type: { title: "What are you building?", desc: "Select the category that best fits your project." },
        budget: { title: "What's your estimated budget?", desc: "This helps us recommend the right tech stack." },
        timeline: { title: "When do you need this?", desc: "We'll allocate resources accordingly." },
        details: { title: "Where should we send the estimate?", desc: "We'll get back to you within 24 hours." },
        success: { title: "Message Received!", desc: "Our team will review your requirements and contact you shortly." }
    };

    // Functions
    function updateUI() {
        const stepName = steps[currentStep];
        
        // Update Progress Bar
        if (progressBar) {
            progressBar.style.width = `${(currentStep / 3) * 100}%`;
            if (currentStep === 4) progressBar.style.width = '100%';
        }

        // Update Indicators
        stepIndicators.forEach((el, i) => {
            if (i <= currentStep) {
                el.classList.add('border-primary', 'text-primary', 'font-bold');
                el.classList.remove('border-secondary', 'text-muted-foreground');
            } else {
                el.classList.remove('border-primary', 'text-primary', 'font-bold');
                el.classList.add('border-secondary', 'text-muted-foreground');
            }
        });

        // Show/Hide Content
        stepContents.forEach(el => el.classList.add('hidden'));
        document.getElementById(`step-${stepName}`)?.classList.remove('hidden');

        // Update Title & Desc
        if (stepTitle) stepTitle.textContent = stepInfo[stepName].title;
        if (stepDesc) stepDesc.textContent = stepInfo[stepName].desc;

        // Update Footer
        if (backBtn) {
            if (currentStep === 0 || currentStep === 4) backBtn.classList.add('hidden');
            else backBtn.classList.remove('hidden');
        }

        if (stepCounter) {
            if (currentStep === 4) stepCounter.classList.add('hidden');
            else {
                stepCounter.classList.remove('hidden');
                stepCounter.textContent = `Step ${currentStep + 1} of 4`;
            }
        }

        if (footerNav && currentStep === 4) {
            footerNav.classList.add('hidden');
        }

        // Update Summary in Details step
        if (stepName === 'details') {
            if (summaryType) summaryType.textContent = data.type;
            if (summaryBudget) summaryBudget.textContent = data.budget;
            if (summaryTimeline) summaryTimeline.textContent = data.timeline;
        }

        // Highlight selected options
        document.querySelectorAll('.type-option, .budget-option, .timeline-option').forEach(btn => {
            const val = btn.getAttribute('data-value');
            const type = btn.classList.contains('type-option') ? 'type' : 
                         btn.classList.contains('budget-option') ? 'budget' : 'timeline';
            
            if (data[type] === val) {
                btn.classList.add('border-primary', 'bg-accent/50');
                btn.classList.remove('border-border');
                btn.querySelector('.icon-container')?.classList.add('bg-primary/10');
                btn.querySelector('.icon')?.classList.add('text-primary');
            } else {
                btn.classList.remove('border-primary', 'bg-accent/50');
                btn.classList.add('border-border');
                btn.querySelector('.icon-container')?.classList.remove('bg-primary/10');
                btn.querySelector('.icon')?.classList.remove('text-primary');
            }
        });
    }

    function nextStep() {
        if (currentStep < steps.length - 1) {
            currentStep++;
            updateUI();
        }
    }

    function prevStep() {
        if (currentStep > 0) {
            currentStep--;
            updateUI();
        }
    }

    // Event Listeners
    document.querySelectorAll('.type-option').forEach(btn => {
        btn.addEventListener('click', () => {
            data.type = btn.getAttribute('data-value') || '';
            nextStep();
        });
    });

    document.querySelectorAll('.budget-option').forEach(btn => {
        btn.addEventListener('click', () => {
            data.budget = btn.getAttribute('data-value') || '';
            nextStep();
        });
    });

    document.querySelectorAll('.timeline-option').forEach(btn => {
        btn.addEventListener('click', () => {
            data.timeline = btn.getAttribute('data-value') || '';
            nextStep();
        });
    });

    backBtn?.addEventListener('click', prevStep);

    form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!submitBtn) return;

        // Collect form data
        const formData = new FormData(form as HTMLFormElement);
        data.name = formData.get('name') as string;
        data.email = formData.get('email') as string;
        data.company = formData.get('company') as string;
        data.description = formData.get('description') as string;
        // @ts-ignore
        data['cf-turnstile-response'] = formData.get('cf-turnstile-response') as string;

        // Add summary
        // @ts-ignore
        data.summary = `Looking for a ${data.type} with a budget of ${data.budget}, needed ${data.timeline}.`;

        // Loading state
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Sending...';

        console.log('Sending project data:', data);

        try {
            // Try sending to the webhook directly first
            // If CORS fails, we might need a proxy, but let's try direct first as requested
            const response = await fetch('/api/calculator', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                currentStep = 4; // Success step
                updateUI();
            } else {
                const errorText = await response.text();
                console.error('Webhook error response:', errorText);
                throw new Error('Failed to submit project details');
            }
        } catch (error) {
            console.error('Error submitting project:', error);
            alert("Something went wrong. Please try again later.");
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    });

    // Initialize
    updateUI();
</script>
